# ./compose.yml

version: "3.2"
services:

# ##################
# COMMON 
# ##################

  common: &common
    image: "distrobuilder" 
    entrypoint: [ "bash", "-c" ]
    volumes:
      - ../ansible:/ansible
    working_dir: /ansible
    env_file:
      - "${ENV_FILE}"
    privileged: true

# ##################
# PREPARE 
# ##################

  prepare:
    <<: *common
    image: "distrobuilder-prepare" 
    build:
      context: ../
      dockerfile: './build/Ansible'
    command: 
      - |
        ansible-playbook            \
          ./playbooks/playbook.yml  \
          --inventory               \
          ./inventory/hosts;

# ##################
# EXECUTE 
# ##################

  execute:
    <<: *common
    image: "distrobuilder-execute" 
    build:
      context: ../
      dockerfile: './build/Distrobuilder'
    command: 
      - |
        distrobuilder               \
          build-lxc                 \
          /ansible/debian.yml;
