# ./compose.yml

version: "3.2"
services:

# ##################
# COMMON 
# ##################

  common: &common
    image: "distrobuilder" 
    entrypoint: [ "bash", "-c" ]
    build:
      context: ../
      dockerfile: './build/Dockerfile'
    volumes:
      - ../ansible:/ansible
      - distrobuilder:/distrobuilder
    env_file:
      - "${ENV_FILE}"
    privileged: true

# ##################
# PLAY 
# ##################

  play:
    <<: *common
    working_dir: /ansible
    command: 
      - |
        ansible-playbook            \
          ./playbooks/playbook.yml  \
          --inventory               \
          ./inventory/hosts;

        distrobuilder               \
          build-lxc                 \
          /distrobuilder/debian.yml;

volumes:
  distrobuilder:
