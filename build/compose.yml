# ./compose.yml

version: "3.2"
services:

# ##################
# COMMON 
# ##################

  common: &common
    image: "distrobuilder" 
    entrypoint: [ "bash", "-c" ]
    build:
      context: ../
      dockerfile: './build/Dockerfile'
    volumes:
      - ../ansible:/ansible
      - distrobuilder:/distrobuilder
    env_file:
      - "${ENV_FILE}"
    privileged: true

# ##################
# PREPARE 
# ##################

  prepare:
    <<: *common
    working_dir: /ansible
    command: 
      - |
        ansible-playbook            \
          ./playbooks/playbook.yml  \
          --inventory               \
          ./inventory/hosts;

# ##################
# BUILD
# ##################

  build:
    <<: *common
    working_dir: /distrobuilder
    command: 
      - |
        distrobuilder \
          build-lxc   \
          /debian.yml;
    depends_on:
      - 'prepare'


volumes:
  distrobuilder:
